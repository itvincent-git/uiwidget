(function(d){d.uiwidget=d.uiwidget||{};d.uiwidget.Combobox=function(a,b){d.extend(this,b);this.el=a;this.init();this.render()};d.uiwidget.Combobox.prototype={width:110,maxHeight:200,valueField:"value",displayField:"text",readOnly:false,lazyInit:true,queryName:"combobox",cache:false,init:function(){if(this.data)this.cacheDate=this.data;this.paras={}},render:function(){this.selectedIndex=-1;this.el.addClass("f-combobox");this.el.wrap('<div class="f-combobox-wrap"></div>');this.wrap=this.el.parent();
this.trig=d('<input type="button" class="f-arrow-trigger" hideFocus="true"/>');this.el.after(this.trig);this.lazyInit?this.el.one("focus",d.proxy(this,"initList")):this.initList();this.el.bind("focus",d.proxy(this,"onFocus"));this.trig.bind("click",d.proxy(this,"onTriggerClick"));this.el.bind("keyup",d.proxy(this,"onKeyup"));this.initValue()},initValue:function(){if(this.value!==undefined)this.setValue(this.value);else if(this.getValue()!=undefined)this.value=this.getValue();this.originalValue=this.getValue();
if(this.hiddenField)this.hiddenField.value=this.hiddenValue!==undefined?this.hiddenValue:this.value},initList:function(){this.renderList();this.loadData();this.list.width(this.el.outerWidth()+this.trig.outerWidth()-2);this.listInner=this.list.find(".f-combobox-list-inner");d(".f-combobox-list-item",this.list[0]).live("mouseover",d.proxy(this,"onListOver")).live("click",d.proxy(this,"onListClick"))},renderList:function(){this.list=d('<div class="f-combobox-list"><div class="f-combobox-list-inner"><ul></ul></div></div>');
this.trig.after(this.list)},replaceList:function(){for(var a=["<ul>"],b=0;b<this.data.length;b++)a.push('<li class="f-combobox-list-item">',this.data[b][this.displayField],"</li>");a.push("</ul>");this.list.find("ul").replaceWith(a.join(""))},onTriggerClick:function(){if(!(this.readOnly||this.disabled))if(this.isExpanded()){this.el.focus();this.collapse()}else{this.el.focus();this.clearFilter();this.expand();this.selectByValue(this.getValue(),true)}},clearFilter:function(){if(this.filtered){this.replaceList();
this.filtered=false}if(this.url&&this.hasQuery){this.paras={};this.loadData();this.hasQuery=false}},onFocus:function(){this.el.select()},onKeyup:function(a){a=a.which;if(a==8)this.filter(this.getValue(),true);else if(a==13){this.selectedIndex=-1;this.collapse()}else if(a==40)if(this.isExpanded())this.selectNext();else{this.clearFilter();this.expand();this.selectByValue(this.getValue(),true)}else if(a==38)this.selectPrev();else{this.dly&&this.removeDelay(this.dly);var b=this.getValue();this.dly=this.delay(function(){this.filter(b)},
500)}},triggerBlur:function(a){a.target!=this.trig[0]&&!d.contains(this.wrap[0],a.target)&&this.collapse()},onListClick:function(a){this.selectByTarget(d(a.target));this.collapse();this.onFocus()},onListOver:function(a){this.selectByTarget(d(a.target),true)},selectByTarget:function(a,b){this._selectByIndex(this.list.find(".f-combobox-list-item").index(a),b)},_selectByIndex:function(a,b){if(a<0)this.selectedIndex=0;else{var c=this.listInner.find(".f-combobox-list-item"),e=c.eq(this.selectedIndex);
this.selectedIndex=a;c=c.eq(a);if(c.length>0){e.removeClass("f-combobox-list-item-selected");c.addClass("f-combobox-list-item-selected");b||this.setValue(c.html())}else this.selectedIndex=a<=0?0:a-1;return c}},selectByIndex:function(a,b){(a=this._selectByIndex(a,b))&&a.length>0&&this.scrollToItem(a,false)},scrollToItem:function(a,b){if(a){var c=this.getScrollPos(),e=this.getScrollArea(),f=a.getOffsetsTo(this.list).top+c;a=f+a.outerHeight();if(f<c)this.scrollTo(f,b);else a>c+e&&this.scrollTo(a-e,b)}},
getScrollPos:function(){return this.list.scrollTop()},getScrollArea:function(){return this.list.height()},scrollTo:function(a,b){b?this.list.animate({scrollTop:a},"fast","linear"):this.list.scrollTop(a)},selectNext:function(){this.selectByIndex(this.selectedIndex+1)},selectPrev:function(){this.selectByIndex(this.selectedIndex-1)},putParameter:function(a){d.extend(this.paras,a)},getParameter:function(){return this.paras},getQueryName:function(){return this.queryName},filter:function(a,b){if(this.url){var c=
{};c[this.getQueryName()]=this.getValue();this.putParameter(c);this.loadData();this.expand();this.hasQuery=true;if(this.data.length>0){this.selectByIndex(0,b);b||this.selectText(a.length)}}else{c=[];for(var e=0,f=this.data.length;e<f;e++)this.data[e].text.toLowerCase().indexOf(a.toLowerCase())!=-1&&c.push(this.data[e]);this.data=c;this.replaceList();this.expand();if(this.data.length>0){this.selectByIndex(0,b);b||this.selectText(a.length)}this.data=this.cacheDate;this.filtered=true}},selectByValue:function(a,
b){for(var c=-1,e=0,f=this.data.length;e<f;e++)if(this.data[e].text.indexOf(a)!=-1){c=e;break}c>-1&&this.selectByIndex(c,b)},getValue:function(){return this.el.val()},setValue:function(a){this.value=a;this.el.val(a)},isExpanded:function(){return this.list&&this.list.is(":visible")},collapse:function(){if(this.isExpanded()){this.list.hide();d(document).unbind("mousedown");this.triggerHandler("collapse")}},expand:function(){if(this.data.length<1)this.collapse();else{if(!this.isExpanded()){d(document).bind("mousedown",
d.proxy(this,"triggerBlur"));this.showList();this.triggerHandler("expand")}this.restrictList();this.alignList()}},restrictList:function(){this.setListHeight(Math.min(this.listInner.height(),this.maxHeight))},setListHeight:function(a){this.list.height(a)},alignList:function(){var a=this.el,b=a.offset(),c;c=b.left;a=a.outerHeight();a=b.top+a;var e=this.list.width(),f=this.list.height(),h=d(window).width(),g=d(window).height();if(c+e>h){c-=e;if(c<0)c=0}if(a+f>g){_top=b.top-f;if(_top<0){e=g-a;if(_top<
e)this.setListHeight(e);else{a=0;this.setListHeight(b.top)}}else a=_top}this.list.css("left",c);this.list.css("top",a)},showList:function(a){this.list.show(a)},selectText:function(a,b){var c=this.getValue(),e=false;if(c.length>0){a=a===undefined?0:a;b=b===undefined?c.length:b;var f=this.el[0];if(f.setSelectionRange)f.setSelectionRange(a,b);else if(f.createTextRange){f=f.createTextRange();f.moveStart("character",a);f.moveEnd("character",b-c.length);f.select()}}else e=true;e&&this.el.focus()},reset:function(){this.setValue(this.originalValue)},
delay:function(a,b){return setTimeout(d.proxy(a,this),b)},removeDelay:function(a){clearTimeout(a)},loadData:function(){this.url?d.ajax({dataType:"json",async:false,type:"POST",url:this.url,data:this.paras,cache:this.cache,timeout:this.timeout||6E4,contentType:"application/x-www-form-urlencoded; charset=UTF-8",success:d.proxy(this.loadSuccess,this)}):this.replaceList()},loadSuccess:function(a){this.data=a;this.replaceList()},bind:function(a,b,c){a=a.toLowerCase();return typeof b=="object"?this.el.bind(a,
b,c):this.el.bind(a,b)},trigger:function(a,b){return this.el.trigger(a,b)},triggerHandler:function(a,b,c){a=a.toLowerCase();if(c){if(this.el[0]){c.type=a;c.triggerTarget=c.target;c.stopPropagation();d.event.trigger(c,b,this.el[0],false);return c.result}}else return this.el.triggerHandler(a,b)}};d.fn.combobox=function(a){return new d.uiwidget.Combobox(this,a)};d.fn.extend({getOffsetsTo:function(a){if(!this[0])return null;var b=this[0],c=this.offset(),e=/^body|html$/i.test(a[0].nodeName)?{top:0,left:0}:
a.offset();c.top-=parseFloat(jQuery.curCSS(b,"marginTop",true))||0;c.left-=parseFloat(jQuery.curCSS(b,"marginLeft",true))||0;e.top+=parseFloat(jQuery.curCSS(a[0],"borderTopWidth",true))||0;e.left+=parseFloat(jQuery.curCSS(a[0],"borderLeftWidth",true))||0;return{top:c.top-e.top,left:c.left-e.left}}})})(jQuery);
