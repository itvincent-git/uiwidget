/**
* Tree组件
*
* @author Vincent (zhongyongsheng@ceopen.cn)
* @date 2010-11-01
* @version 2.1.0-SNAPSHOT
*/
(function(){$.uiwidget=$.uiwidget||{};$.uiwidget.Tree=function(a,b){$.extend(this,b);this.el=$(a);this.init();this.autoRender&&this.render()};$.uiwidget.Tree.prototype={autoExpandRoot:true,defaultTimeout:6E4,autoRender:true,showIcons:true,cache:false,async:false,init:function(){var a=this;this.nodeHash={};this.loadParas={};$.each(["beforeLoad","afterLoad"],function(b,c){a[c]&&a.bind(c,a[c])})},expandAll:function(){this.getContainerNode().expand(true)},collapseAll:function(){this.getContainerNode().eachChild(function(a){a.collapse(true)})},
expandRoot:function(){this.getContainerNode().eachChild(function(a){a.expand()})},setLoadParas:function(a){for(var b in a)if(a[b])this.loadParas[b]=a[b]},loadData:function(a){this.loadParas={};if(a){a.data.id&&this.setLoadParas({id:a.data.id});this.triggerHandler("beforeLoad",[a,this])}var b=this;$.ajax({async:this.async,cache:this.cache,dataType:"json",type:"POST",url:this.url,data:this.loadParas,timeout:this.timeout||this.defaultTimeout,contentType:"application/x-www-form-urlencoded; charset=UTF-8",
success:function(c){b.data=c||{}}});a&&this.triggerHandler("afterLoad",[a,this])},render:function(){this.wraper=$(['<div class="tree" ',this.height?'style="height:'+this.height+'px" ':"","></div>"].join(""));this.el.append(this.wraper);this.containerNode=new $.uiwidget.TreeNode({el:this.wraper,indent:[],tree:this,isContainer:true,data:{children:this.data}});!this.data&&this.url&&this.loadData(this.containerNode);this.containerNode.appendChildByData(this.data);this.containerNode.expand();this.autoExpandRoot&&
this.expandRoot();this.addEvent()},addEvent:function(){this.el.dblclick($.proxy(this,"onDblclick")).click($.proxy(this,"onClick")).bind("contextmenu",$.proxy(this,"onContextmenu"))},onClick:function(a){a=$(a.target);if(a.is(".tree-node-text")||a.is(".tree-node-icon")){var b=this.getNode(a.parent());b.select(true);this.triggerHandler("nodeClick",[b])}else if(a.is(".tree-expand-icon")){b=this.getNode(a.parent());b.toggle()}else if(a.is(".tree-node-checkbox")){b=this.getNode(a.parent());b.data.checked=
a[0].checked;this.triggerHandler("checkchange",[b,a[0].checked])}},onDblclick:function(a){a=$(a.target);if(a.is(".tree-node-text")||a.is(".tree-node-icon")){a=this.getNode(a.parent());a.toggle();this.triggerHandler("nodeDblclick",[a])}},onContextmenu:function(a){var b=$(a.target);if(b.is(".tree-node-text")||b.is(".tree-node-icon")){a.preventDefault();b=this.getNode(b.parent());this.triggerHandler("treeContextMenu",[this,b],a);this.handlerContextMenu(b,a)}},getNode:function(a){if(a=a[0].className.split(" ")[1].substring(10))return this.getNodeById(a);
return null},getCheckedNode:function(){var a=this;return this.getContainerNode().el.find(":checkbox:checked").map(function(){return a.getNode($(this).parent())})},getSelectedNode:function(){return this.selectedNode},setSelectedNode:function(a){this.selectedNode=a},getRootNode:function(){return this.containerNode.childNodes},getContainerNode:function(){return this.containerNode},reload:function(a){if(!this.url&&this.getContainerNode())this.getContainerNode().data={children:this.data};this.getContainerNode().reload(a)},
getContextMenu:function(){if(!this.cMenu)if($.menu)this.cMenu=$.menu({items:this.contextMenu});return this.cMenu},addContextMenuItem:function(a){return this.getContextMenu().addMenuItem(a)},handlerContextMenu:function(a,b){b.preventDefault();var c=this.getContextMenu();if(c&&c.size()>1){a.select(false);c.showAt(b.pageX,b.pageY)}},getData:function(){return this.data},getNodeById:function(a){return this.nodeHash[a]},registerNode:function(a){this.nodeHash[a.data.id]=a},unregisterNode:function(a){delete this.nodeHash[a.data.id]},
selectPath:function(a,b){function c(f){if(d==f.data.id)if(d=e.shift()){f.expand();f.eachChild(c)}else{f.select(b);return false}}var e=a.split("/"),d=e.shift();this.getContainerNode().eachChild(c)},destroy:function(){this.el.unbind("dblclick click contextmenu");this.el.empty()},bind:function(a,b,c){a=a.toLowerCase();return typeof b=="object"?this.el.bind(a,b,c):this.el.bind(a,b)},trigger:function(a,b){return this.el.trigger(a,b)},triggerHandler:function(a,b,c){a=a.toLowerCase();if(c){if(this.el[0]){c.type=
a;c.triggerTarget=c.target;c.stopPropagation();$.event.trigger(c,b,this.el[0],false);return c.result}}else return this.el.triggerHandler(a,b)}};$.uiwidget.TreeNode=function(a){$.extend(this,a);this.init()};$.uiwidget.TreeNode.prototype={isRendered:false,firstChild:null,lastChild:null,previousSibling:null,nextSibling:null,ct:null,indent:null,init:function(){this.childNodes=[];this.leaf=this.data&&this.data.leaf;this.expanded=false},createNodeArray:function(){var a=this.data,b=['<li class="tree-node',
" tree-node-",a.id,a.disabled?" tree-node-disabled":"",'" title="',a.title,'">'];b.push('<span class="tree-indent">');b=b.concat(this.buildIntent());b.push('</span><input type="button" hideFocus="true" class="');b.push(this.buildExpandIcon().join(" "));b.push('"/>');if(this.tree?this.tree.showIcons:true)a.children||!this.isLeaf()?b.push('<input type="button" hideFocus="true" class="tree-node-icon tree-node-folder',this.isContainer?" tree-node-root":"",'"/>'):b.push('<input type="button" hideFocus="true" class="tree-node-icon tree-node-leaf"/>');
if(a.checked==="false"||a.checked===false)b.push('<input class="tree-node-checkbox"',a.disabled?' disabled="true"':"",' type="checkbox"/>');else if(a.checked==="true"||a.checked===true)b.push('<input class="tree-node-checkbox" type="checkbox" checked="true"/>');b.push('<span class="tree-node-text" unselectable="on">',a.text,"</span></li>");return b},getEl:function(){if(!this.el)this.el=this.tree.el.find([".tree-node-",this.data.id].join(""));return this.el},getExpandIcon:function(){return this.expandIcon||
(this.expandIcon=this.getEl().children(".tree-expand-icon"))},getIndent:function(){return this.indent||(this.indent=this.getEl().children(".tree-indent"))},getFolder:function(){return this.folder||(this.folder=this.getEl().children(".tree-node-folder"))},renderIndent:function(a){this.getIndent().html(this.buildIntent().join(""));this.updateExpandIcon();if(a===true&&this.ct!=null)for(var b=this.childNodes,c=0,e=b.length;c<e;c++)b[c].renderIndent(a)},buildIntent:function(){for(var a=[],b=this.parentNode;b;){b.isContainer||
(b.isLast()?a.unshift('<input type="button" hideFocus="true" class="tree-blank"/>'):a.unshift('<input type="button" hideFocus="true" class="tree-blank tree-line"/>'));b=b.parentNode}return a},updateExpandIcon:function(){if(this.isRendered){var a=this.buildExpandIcon();if(this.getExpandIcon().length>0)this.getExpandIcon()[0].className=a.join(" ")}},buildExpandIcon:function(){var a=["tree-expand-icon"],b=[];this.isLast()?b.push("tree-elbow-end"):b.push("tree-elbow");this.isLeaf()||(this.expanded?b.push("-minus"):
b.push("-plus"));a.push(b.join(""));return a},appendChildByData:function(a){if(a){for(var b=[],c=0,e=a.length;c<e;c++){var d=new $.uiwidget.TreeNode({data:a[c],tree:this.tree});this.childNodes.length==0&&this.setFirstChild(d);c==e-1&&this.setLastChild(d);d.parentNode=this;var f=d.parentNode.childNodes[c-1];if(f){d.previousSibling=f;f.nextSibling=d}else d.previousSibling=null;d.nextSibling=null;b=b.concat(d.createNodeArray());this.childNodes.push(d);this.tree.registerNode(d);d.isRendered=true}this.getCt().append(b.join(""));
this.leaf=false}},getCt:function(){if(!this.ct||this.ct.length==0){this.ct=$('<div class="tree-node-ct"/>');this.isContainer?this.getEl().append(this.ct):this.getEl().after(this.ct)}return this.ct},appendChild:function(a){if(a.appendChild)this.appendChild(a.data);else if($.isArray(a)){if(a.length>1)throw"This parameter can not be an array.";}else{var b=[];b.push(a);this.appendChildByData(b)}},setFirstChild:function(a){var b=this.firstChild;this.firstChild=a;b&&b.isRendered&&a!=b&&b.renderIndent(true);
this.isRendered&&this.renderIndent(true)},setLastChild:function(a){var b=this.lastChild;this.lastChild=a;b&&b.isRendered&&a!=b&&b.renderIndent(true);this.isRendered&&this.renderIndent(true)},removeChild:function(a){var b=$.inArray(a,this.childNodes);if(b==-1)return false;this.childNodes.splice(b,1);if(a.previousSibling)a.previousSibling.nextSibling=a.nextSibling;if(a.nextSibling)a.nextSibling.previousSibling=a.previousSibling;this.firstChild==a&&this.setFirstChild(a.nextSibling);this.lastChild==a&&
this.setLastChild(a.previousSibling);a.parentNode=null;a.previousSibling=null;a.nextSibling=null;a.ct&&a.ct.remove();a.getEl().remove();if(this.childNodes.length<1){this.collapse();this.leaf=true}this.updateExpandIcon();this.tree.unregisterNode(a);return a},isLast:function(){return!this.parentNode?true:this.parentNode.lastChild==this},isLeaf:function(){return this.leaf},setText:function(a){this.data.text=a;this.getEl().children(".tree-node-text").text(a)},getText:function(){return this.getEl().children(".tree-node-text").text()},
getHrefTarget:function(){return this.hrefTarget||(this.hrefTarget=this.data&&this.data.hrefTarget||this.tree.hrefTarget)},select:function(a){if(!this.data.disabled){this.tree.getSelectedNode()&&this.tree.getSelectedNode().getEl().find(".tree-node-selected").removeClass("tree-node-selected");this.tree.setSelectedNode(this);this.getEl().find(".tree-node-text").addClass("tree-node-selected");var b=this.data.href;this.hrefTarget=this.getHrefTarget();if(a&&b&&b.length>0)if(this.tree.ajaxLoadPage)$.fn.page?
$(this.hrefTarget).page(b):alert("please import page plugin.");else if(typeof this.hrefTarget=="string")window.frames[this.hrefTarget].location=b;else this.hrefTarget.location=b}},unselect:function(){var a=this.getEl().find(".tree-node-selected");if(a.length>0){a.removeClass("tree-node-selected");this.tree.setSelectedNode(null)}},isSelected:function(){return this.getEl().find(".tree-node-selected").length>0},renderChildren:function(){var a;if(!this.isLeaf()){if(this.data.children)a=this.data.children;
else if(this.tree.url){this.tree.loadData(this);a=this.tree.data}if(!a)return;this.appendChildByData(a)}return this.ct},toggle:function(){this.expanded?this.collapse():this.expand()},expand:function(a){if(!this.ct||this.ct.length==0)this.ct=this.renderChildren();if(this.ct&&this.ct.length>0)this.ct[0].style.display="block";this.expanded=true;this.isLeaf()||this.updateExpandIcon();if((this.tree?this.tree.showIcons:true)&&this.getFolder())this.getFolder().addClass("tree-node-folderopen");if(a)for(var b=
0;b<this.childNodes.length;b++)this.childNodes[b].isLeaf()||this.childNodes[b].expand(a)},collapse:function(a){if(this.ct&&this.ct.length>0)this.ct[0].style.display="none";this.expanded=false;this.isLeaf()||this.updateExpandIcon();if((this.tree?this.tree.showIcons:true)&&this.getFolder())this.getFolder().removeClass("tree-node-folderopen");if(a)for(var b=0;b<this.childNodes.length;b++)this.childNodes[b].isLeaf()||this.childNodes[b].collapse(a)},reload:function(a){if(this.ct){this.ct.remove();delete this.ct;
this.expanded=false;this.childNodes=[]}this.expand();a&&a(this)},remove:function(){this.parentNode.removeChild(this)},enable:function(){this.data.disabled=false;this.getEl().removeClass("tree-node-disabled");this.getEl().find(".tree-node-checkbox").attr("disabled",false)},disable:function(){this.unselect();this.data.disabled=true;this.getEl().addClass("tree-node-disabled");this.getEl().find(".tree-node-checkbox").attr("disabled",true)},getData:function(){return this.data},checkChange:function(a,b){this.getEl().find(".tree-node-checkbox").attr("checked",
a);this.data.checked=a;b===true&&this.tree.triggerHandler("checkchange",[this,a])},cascade:function(a){if(a(this)!==false)for(var b=this.childNodes,c=0,e=b.length;c<e;c++)b[c].cascade(a)},eachChild:function(a){for(var b=this.childNodes,c=0,e=b.length;c<e;c++)if(a(b[c])===false)break},getPath:function(){for(var a=[],b=this;b;){var c=b.data.id;c&&a.unshift(c);b=b.parentNode}return a.join("/")},bind:function(a,b,c){return typeof b=="object"?this.getEl().bind(a,b,c):this.getEl().bind(a,b)},trigger:function(a,
b){return this.getEl().trigger(a,b)},triggerHandler:function(a,b){return this.getEl().triggerHandler(a,b)}};$.fn.tree=function(a){return new $.uiwidget.Tree(this,a)}})(jQuery);
