/**
* ±êÇ©×é¼þ
*
* @author Vincent (zhongyongsheng@ceopen.cn)
* @date 2011-04-08
* @version 2.0.2
*/
(function(d){d.uiwidget=d.uiwidget||{};d.uiwidget.Tab=function(a,b){d.extend(this,b);this.el=d(a);this.init();this.render()};d.uiwidget.Tab.prototype={tabIdGenerator:0,enableTabScroll:false,scrollIncrement:100,init:function(){this.tabItems=[];this.onTabClose&&this.bind("tabClose",this.onTabClose);this.onTabChange&&this.bind("tabChange",this.onTabChange)},render:function(){this.container=d('<div class="tab"></div>');this.el.append(this.container);this.renderHeader();this.renderBody();this.beginUpdate();
for(var a=0;a<this.items.length;a++)this.addItem(this.items[a]);this.endUpdate();if(this.initActiveTab!==undefined)this.activeTab(this.initActiveTab=="string"?this.initActiveTab:this.tabItems[this.initActiveTab])},renderHeader:function(){this.header=d('<div class="tab-header"><div class="tab-tabmenu-right"></div><div class="tab-scroller-right"/><div class="tab-scroller-left tab-scroller-left-disabled"/><div class="tab-strip-wrap"><div class="tab-strip"><ul class="tab-edge"/></div></div></div>');this.container.append(this.header);
this.tabStrip=this.container.find("div.tab-strip");this.tabEdge=this.container.find("ul.tab-edge");this.stripWrap=this.container.find("div.tab-strip-wrap");if(this.enableTabScroll){this.scrollLeft=this.container.find("div.tab-scroller-left");this.scrollRight=this.container.find("div.tab-scroller-right");this.tabMenuRight=this.container.find("div.tab-tabmenu-right");this.scrollLeft.click(d.proxy(this,"handlerScrollLeft"));this.scrollRight.click(d.proxy(this,"handlerScrollRight"));this.tabMenuRight.click(d.proxy(this,
"showTabMenu"));this.container.resize(d.proxy(this,"setStripWrapWidth"));this.setStripWrapWidth()}d("ul:not(.tab-edge)",this.tabStrip[0]).live("click",d.proxy(this,"onTabClick"));d(".tab-close",this.tabStrip[0]).live("click",d.proxy(this,"onTabCloseClick"))},setStripWrapWidth:function(){this.stripWrap.width(this.container.width()-this.scrollLeft.width()-this.scrollRight.width()-this.tabMenuRight.width())},getTabMenu:function(){if(!d.fn.menu)throw"please import menu plugin.";this.tabMenu=d(document.body).menu({});
var a=this;if(this.tabItems)for(var b=0;b<this.tabItems.length;b++)this.tabMenu.addMenuItem({id:this.tabItems[b].id,text:this.tabItems[b].text,handler:function(c,e){a.activeTab(e)}});return this.tabMenu},showTabMenu:function(a){this.getTabMenu().showAlignTo(a.target)},addItem:function(a,b){var c=this.getTabId(a);this.tabItems.push(a);a=d(['<ul tabId="',c,'" ',a.disabled?'class="disabled"':"",'><li class="left"></li><li class="middle',a.closeable?" middle-close":"",'"><div class="header-text">',a.text,
"</div>",a.closeable?'<a class="tab-close"></a>':"",'</li><li class="right"></li></ul>'].join(""));if(b)b.id&&this.tabStrip.children("ul[tabId="+b.id+"]")[b.position](a);else this.tabEdge.before(a);this.delegateUpdates()},onTabClick:function(a){var b=d(a.currentTarget),c=this.findTabId(b),e=this.searchItem(c);if(!b.hasClass("disabled")){var f=this.getActiveItem();if(f!=e){c=this.getTabContent(c);if(e.beforeActivate)if(e.beforeActivate(a,this,e,b,c)===false)return;this.loadTabContent(e,c);this.getActiveTab().removeClass("on");
b.addClass("on");this.hideContent();c.show();f&&f.onDeactivate&&f.onDeactivate(a,this,f,b,c);e.onActivate&&e.onActivate(a,this,e,b,c);if(!f||f&&f!=e){a=c.find("iframe[id="+e.id+"]");this.triggerHandler("tabChange",[f,e,b,c,a,this])}}}},onTabCloseClick:function(a){a=this.findTabId(d(a.target).closest("ul"));var b=this.searchItem(a);this.closeTab(a);this.triggerHandler("tabClose",[b]);return false},renderBody:function(){this.body=d('<div class="tab-body"></div>');this.container.append(this.body)},getTabContent:function(a){var b=
this.body.children('.tab-content[tabId="'+a+'"]');if(b.length<1){b=this.renderContent(a);this.body.append(b)}return b},renderContent:function(a){var b=this.searchItem(a);a=d(['<div class="tab-content" tabId="',a,'" ></div>'].join(""));if(b.href)this.ajaxLoadPage||a.append(['<iframe id="',b.id,'" name="',b.id,'" height="',b.height?b.height:this.height,'" width="100%" scrolling="auto" frameborder="0" allowtransparency="true" align="top" ></iframe>'].join(""));else if(b.iframe)a.append(b.iframe);else if(b.html)a.append(b.html);
else if(b.contentEl)a.append(typeof b.contentEl=="string"?d(b.contentEl):b.contentEl);return a},beginUpdate:function(){this.suspendUpdates=true},endUpdate:function(){this.suspendUpdates=false;this.delegateUpdates()},delegateUpdates:function(){this.suspendUpdates||this.enableTabScroll&&this.autoScrollTabs()},autoScrollTabs:function(){var a=this.stripWrap.width();if(!(!this.enableTabScroll||this.items.length<1))if(this.getScrollWidth()<=a)this.scrolling&&this.deActivateScrollers();else{this.scrolling||
this.activateScrollers();this.updateScrollButtons()}},deActivateScrollers:function(){this.scrollLeft.hide();this.scrollRight.hide();this.tabMenuRight.hide();this.header.removeClass("tab-scrolling");this.scrolling=false},activateScrollers:function(){this.scrollLeft.show();this.scrollRight.show();this.tabMenuRight.show();this.header.addClass("tab-scrolling");this.scrolling=true},scrollTo:function(a){this.stripWrap.animate({scrollLeft:a},"normal","linear",d.proxy(this,"updateScrollButtons"))},getScrollWidth:function(){return this.tabEdge.position().left+
this.getScrollPos()},getScrollPos:function(){return this.stripWrap.scrollLeft()},getScrollArea:function(){return this.stripWrap.width()},getScrollIncrement:function(){return this.scrollIncrement},scrollToTab:function(a,b){if(a){var c=this.getTabHeader(a);a=this.getScrollPos();var e=this.getScrollArea(),f=c.position().left+a;c=f+c.width();if(f<a)this.scrollTo(f,b);else c>a+e&&this.scrollTo(c-e,b)}},handlerScrollRight:function(){var a=this.getScrollWidth()-this.getScrollArea(),b=this.getScrollPos();
a=Math.min(a,b+this.getScrollIncrement());a!=b&&this.scrollTo(a,this.animScroll)},handlerScrollLeft:function(){var a=this.getScrollPos(),b=Math.max(0,a-this.getScrollIncrement());b!=a&&this.scrollTo(b,this.animScroll)},updateScrollButtons:function(){var a=this.getScrollPos();this.scrollLeft[a==0?"addClass":"removeClass"]("tab-scroller-left-disabled");this.scrollRight[a>=this.getScrollWidth()-this.getScrollArea()?"addClass":"removeClass"]("tab-scroller-right-disabled")},activeTab:function(a){this.getTabHeader(a).click();
this.scrolling&&this.scrollToTab(a,this.animScroll)},getTabHeader:function(a){return this.tabStrip.find("ul[tabId="+this.getTabId(a)+"]")},loadTabContent:function(a,b,c){if(a.href)if(this.ajaxLoadPage){if(c||!this.isContentLoaded(b))if(d.fn.page){a.url=a.href;b.page(a);b.attr("loaded",true);b.height(a.height?a.height:this.height)}else alert("Error\uff01\u8bf7\u5bfc\u5165uiwidget-page\u7ec4\u4ef6\u3002")}else{b=b.find("iframe[id="+a.id+"]");if(c||!b[0].src)b[0].src=this.disableCache(a.href)}},disableCache:function(a){var b=
(new Date).getTime(),c=a.replace(/(\?|&)_=.*?(&|$)/,"$1_="+b+"$2");return a=c+(c==a?(a.match(/\?/)?"&":"?")+"_="+b:"")},reloadTab:function(a){this.loadTab(this.searchItem(this.getTabId(a)))},loadTab:function(a){this.loadTabContent(a,this.getTabContent(this.getTabId(a)),true)},isContentLoaded:function(a){return a.attr("loaded")},closeTab:function(a){var b=this.getTabHeader(a);if(b.hasClass("on")){var c=b.next("ul:not(.tab-edge)");if(c.length>0)c.click();else{c=b.prev("ul");c.length>0&&c.click()}}b.remove();
this.getTabContent(a).remove();b=this.searchItem(a);this.removeItem(a);this.delegateUpdates();this.triggerHandler("tabClose",[b])},hideContent:function(){this.body.children("div.tab-content").hide()},getActiveTab:function(){return this.tabStrip.children("ul.on")},enableTab:function(a){this.getTabHeader(a).removeClass("disabled")},disableTab:function(a){this.getTabHeader(a).addClass("disabled")},isDisabledTab:function(a){return this.getTabHeader(a).hasClass("disabled")},getTabId:function(a){return typeof a==
"string"?a:a.id||(a.id="uiwidget-tab-"+this.tabIdGenerator++)},searchItem:function(a){for(var b=0,c=this.tabItems.length;b<c;b++)if(this.tabItems[b].id&&a==this.tabItems[b].id)return this.tabItems[b]},getItems:function(){return this.tabItems},removeItem:function(a){for(var b=0,c=this.tabItems.length;b<c;b++)if(this.tabItems[b].id&&a==this.tabItems[b].id){this.tabItems.splice(b,1);return}},getContentIframe:function(a){return this.getTabContent(a).find("iframe[id="+a+"]")},getActiveItem:function(){return this.searchItem(this.findTabId(this.getActiveTab()))},
setClosable:function(a,b){a=this.getTabHeader(a);var c=a.find(".tab-close");c.length==0&&this.renderCloseButton(a);b?c.show():c.hide()},renderCloseButton:function(a){a.find(".middle").append('<a class="tab-close"></a>')},findTabId:function(a){return a.attr("tabId")},bind:function(a,b,c){typeof b=="object"?this.el.bind(a,b,c):this.el.bind(a,b)},trigger:function(a,b){this.el.trigger(a,b)},triggerHandler:function(a,b){this.el.triggerHandler(a,b)},getIframeById:function(a){return this.getTabContent(a).find("iframe")},
addContentTab:function(a){if(a.closeable!==false)a.closeable=true;if(this.searchItem(a.id)){if(a.refresh===true){this.loadTab(a);this.searchItem(a.id).recordId=a.recordId}}else{this.addItem(a);this.tabItems.length>1&&this.setClosable(this.tabItems[0].id,true)}this.activeTab(a)},getActiveContent:function(){return this.getTabContent(this.getActiveItem().id)},closeActiveTab:function(a){var b=this.getActiveItem(),c=b.parent;this.closeTab(this.getActiveItem().id);if(this.tabItems.length<=0){c.closeable=
false;this.addContentTab(c)}if(a===true&&c!=undefined){this.searchItem(c.id)?this.activeTab(c):this.addContentTab(c);c.reload&&window.setTimeout(function(){try{c.reload.apply(this,b.reloadArgs?b.reloadArgs:[])}catch(e){}},500)}}};d.fn.tab=function(a){return new d.uiwidget.Tab(this,a)};d.fn.resizeIframe=function(a){var b=this[0];try{b.height=(b.Document?b.Document.body.scrollHeight:b.contentDocument.body.offsetHeight)+a.offsetHeight}catch(c){}}})(jQuery);
