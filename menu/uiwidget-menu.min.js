/**
* Menu ²Ëµ¥×é¼þ
*
* @author Vincent (zhongyongsheng@ceopen.cn)
* @date 2011-04-25
* @version 1.2.2
*/
(function(d){d.uiwidget=d.uiwidget||{};d.uiwidget.menuItemIdGenerator=0;d.uiwidget.Menu=function(a){if(d.isArray(a))a={items:a};d.extend(this,a);this.init()};d.uiwidget.Menu.prototype={width:110,init:function(){this.menuItems=[];if(this.items)for(var a=0;a<this.items.length;a++)this.addMenuItem(this.items[a])},render:function(){var a=this;this.el=d('<div class="uiwidget-menu"></div>');this.ul=d("<ul></ul>");this.el.append(this.ul);this.el.width(this.width);this.ghost=d('<div class="uiwidget-menu-ghost"><iframe height=100% width=100% frameborder=0></iframe></div>');
d(document.body).append(this.el);d(document.body).append(this.ghost);this.addMenuEvent();for(var b=0;b<this.menuItems.length;b++)this.ul.append(this.menuItems[b].render());d(document).mousedown(function(){a.hide()})},addMenuItem:function(a){var b;if(typeof a=="object")b=new d.uiwidget.TextMenuItem(this,a);else if(typeof a=="string")b=new d.uiwidget.SeparatorMenuItem(this,a);if(this.ul){b.render();this.ul.append(b.el)}this.menuItems.push(b);return b},removeItem:function(a){for(var b=0,c=this.menuItems.length;b<
c;b++)if(this.menuItems[b].id==a.id){this.menuItems[b].destroy();this.menuItems.splice(b,1);return}},findTargetItem:function(a){a=d(a.target);var b;if(a.is(".uiwidget-menu-item"))b=a;else{a=a.parent(".uiwidget-menu-item");if(a.length>0)b=a}if(b)return this.getMenuItem(b.attr("itemId"))},findTargetItemForLeave:function(a){a=d(a.target);var b,c;if(a.is(".uiwidget-menu-item"))b=a;else if((c=a.parent(".uiwidget-menu-item")).length>0)b=c;else if((c=a.find(".uiwidget-menuitem-hover")).length>0)b=c;if(b)return this.getMenuItem(b.attr("itemId"))},
setActiveItem:function(a,b){if(a!=this.activeItem){this.activeItem&&this.activeItem.deactivate();this.activeItem=a;a.activate(b)}else b&&a.expandMenu()},addMenuEvent:function(){var a=this;this.el.children("ul").mousedown(function(b){b.stopPropagation()}).click(function(b){var c=a.findTargetItem(b);if(c)if(!c.disabled){c.handler&&c.handler(b,c);c.parentMenu&&c.parentMenu.hide(true)}}).mouseover(function(b){var c=a.findTargetItem(b);if(c)c.disabled||a.setActiveItem(c,true);a.over=true;a.triggerHandler("mouseover",
[a,b,c])}).mouseleave(function(b){var c=a.findTargetItemForLeave(b);if(c){if(c==a.activeItem&&c.shouldDeactivate(b)){a.activeItem.deactivate();delete a.activeItem}a.over=false;a.triggerHandler("mouseout",[a,b,c])}})},getMenuItem:function(a){for(var b=0,c=this.menuItems.length;b<c;b++)if(this.menuItems[b].id==a)return this.menuItems[b]},getItemId:function(a){return a.id||(a.id="uiwidget-menu-item-"+d.uiwidget.menuItemIdGenerator++)},isVisible:function(){return this.el&&this.el.is(":visible")},hide:function(a){if(this.el&&
this.isVisible()){this.triggerHandler("beforehide",[this]);if(this.activeItem){this.activeItem.deactivate(true);delete this.activeItem}this.el.hide();this.ghost.hide();this.triggerHandler("hide",[this])}a===true&&this.parentMenu&&this.parentMenu.hide(true)},size:function(){return this.menuItems.length},getEl:function(){return this.el},showAt:function(a,b,c){this.el||this.render();var e,f;if(c){f=c.speed;e=c.action;this.parentMenu=c.parentMenu}c=this.width;var h=this.el.height();if(a+c>d(window).width()){a-=
c;if(a<0)a=0}if(b+h>d(window).height()){b-=h;if(b<0)b=0}this.el.css("left",a);this.el.css("top",b);this.el[e||"show"](f);this.showGhost()},showAlignTo:function(a,b,c){this.el||this.render();var e,f,h;if(c){e=c.offset;f=c.speed;h=c.action;this.parentMenu=c.parentMenu}b||(b="tl-bl");if(!e){e=[];e[0]=0;e[1]=0}a=d(a);c=a.offset();var i,g;if(b=="tl-bl"){i=c.left+e[0];g=c.top+a.height()+e[1]}if(b=="tl-tr"){i=c.left+a.width()+e[0];g=c.top+e[1]}if(b=="tl-br"){i=c.left+a.width()+e[0];g=c.top+a.height()+e[1]}b=
this.getWidth();e=this.getHeight();if(i+b>d(window).width()){i=i-b-(this.parentMenu?this.parentMenu.getWidth():0);if(i<0)i=0}if(g+e>d(window).height()){if(parentMenu)g=g-e+a.outerHeight();else g-=e;if(g<0)g=0}this.el.css("left",i);this.el.css("top",g);this.el[h||"show"](f);this.showGhost()},showGhost:function(){this.ghost.width(this.el.outerWidth());this.ghost.height(this.el.outerHeight());var a=this.el.offset();this.ghost.css("left",a.left);this.ghost.css("top",a.top);this.ghost.show()},bind:function(a,
b,c){typeof b=="object"?this.el.bind(a,b,c):this.el.bind(a,b)},trigger:function(a,b){this.el.trigger(a,b)},triggerHandler:function(a,b){this.el.triggerHandler(a,b)},getWidth:function(){return this.width},getHeight:function(){return this.el.height()}};d.uiwidget.MenuItem=function(a,b){d.extend(this,b);this.init(a)};d.uiwidget.MenuItem.prototype={activeClass:"uiwidget-menuitem-hover",showDelay:200,hideDelay:200,init:function(a){this.parentMenu=a;if(this.menu)this.menu=new d.uiwidget.Menu(this.menu)},
shouldDeactivate:function(a){if(this.menu&&this.menu.isVisible()){var b=a.clientX;a=a.clientY;var c=this.menu.getEl(),e=c.offset(),f=e.left,h=Number(f)+c.width();e=e.top;c=Number(e)+c.height();if(b>=f&&b<=h&&a>=e&&a<=c)return false}return true},activate:function(a){if(this.disabled)return false;this.el.addClass(this.activeClass);a&&this.expandMenu();this.triggerHandler("activate",[this]);return true},deactivate:function(a){this.el.removeClass(this.activeClass);this.hideMenu(a);this.triggerHandler("deactivate",
[this])},expandMenu:function(){if(!this.disabled&&this.menu)this.menu.isVisible()||this.menu.showAlignTo(this.el,"tl-tr",{offset:[8,0],speed:null,parentMenu:this.parentMenu})},hideMenu:function(a){if(this.menu&&this.menu.isVisible()){a&&this.menu.hide();if(!this.hideTimer)this.hideTimer=d.defer(this.deferHide,this.hideDelay,this)}},deferHide:function(){delete this.hideTimer;this.menu.over?this.parentMenu.setActiveItem(this,false):this.menu.hide()},destroy:function(){this.el.remove()},getEl:function(){return this.el},
bind:function(a,b,c){typeof b==="object"?this.el.bind(a,b,c):this.el.bind(a,b)},trigger:function(a,b){this.el.trigger(a,b)},triggerHandler:function(a,b){this.el.triggerHandler(a,b)}};d.uiwidget.TextMenuItem=function(a,b){d.extend(this,b);this.init(a)};d.uiwidget.TextMenuItem.prototype={render:function(){var a=['<li itemId="',this.parentMenu.getItemId(this),'" class="uiwidget-menu-item ',this.disabled===true?" uiwidget-menu-item-disabled ":"",this.menu?'uiwidget-menu-arrow">':'">'];this.icon&&a.push('<img class="uiwidget-menu-item-icon" border="0" align="absbottom"',
'" src="',this.icon,'" /><span class="uiwidget-menu-item-text"> ');a.push(this.text," </span></li>");return this.el=d(a.join(""))}};d.extend(d.uiwidget.TextMenuItem.prototype,d.uiwidget.MenuItem.prototype);d.uiwidget.SeparatorMenuItem=function(a,b){d.extend(this,b);this.init(a)};d.uiwidget.SeparatorMenuItem.prototype={render:function(){var a=['<li itemId="',this.parentMenu.getItemId(this),'" class="uiwidget-menu-line"></li>'];return this.el=d(a.join(""))}};d.extend(d.uiwidget.SeparatorMenuItem.prototype,
d.uiwidget.MenuItem.prototype);d.fn.menu=function(a){return new d.uiwidget.Menu(a)};d.menu=function(a){return new d.uiwidget.Menu(a)};d.createDelegate=function(a,b,c,e){return function(){var f=c||arguments;if(e===true){f=Array.prototype.slice.call(arguments,0);f=f.concat(c)}else if(typeof e=="number"){f=Array.prototype.slice.call(arguments,0);var h=[e,0].concat(c);Array.prototype.splice.apply(f,h)}return a.apply(b||window,f)}};d.defer=function(a,b,c,e,f){a=d.createDelegate(a,c,e,f);if(b)return setTimeout(a,
b);a();return 0};d.isArray=function(a){return Object.prototype.toString.apply(a)==="[object Array]"};d.isObject=function(a){return Object.prototype.toString.apply(a)==="[object Object]"}})(jQuery);
